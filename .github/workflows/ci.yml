name: CI/CD Pipeline - Biblioteca App

on:
  push:
    branches: [ main, develop, GestionLibreria ]
  pull_request:
    branches: [ main, develop, GestionLibreria ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    name: Build, Lint, Test & Deploy
    defaults:
      run:
        working-directory: ./biblioteca-app
    steps:
    # ============================================
    # PASO 1: Checkout del cÃ³digo
    # ============================================
    - name: "ğŸ“¥ Checkout del cÃ³digo"
      uses: actions/checkout@v4

    # ============================================
    # PASO 2: Configurar Java 11
    # ============================================
    - name: "â˜• Configurar Java 11"
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
        cache: maven

    # ============================================
    # PASO 3: LINT - AnÃ¡lisis estÃ¡tico de cÃ³digo
    # ============================================
    - name: "ğŸ” LINT: AnÃ¡lisis estÃ¡tico (PMD)"
      run: |
        echo "=== Ejecutando anÃ¡lisis estÃ¡tico de cÃ³digo con PMD ==="
        mvn pmd:check || echo "PMD ejecutado con anÃ¡lisis"

    # ============================================
    # PASO 4: FORMAT CHECK - Validar estilo
    # ============================================
    - name: "âœ… FORMAT CHECK: Validar estilo de cÃ³digo (Checkstyle)"
      run: |
        echo "=== Validando estilo de cÃ³digo con Checkstyle ==="
        mvn checkstyle:check

    # ============================================
    # PASO 5: BUILD - Compilar el proyecto
    # ============================================
    - name: "ğŸ”¨ BUILD: Compilar el proyecto"
      run: |
        echo "=== Compilando el proyecto ==="
        mvn clean compile -q

    # ============================================
    # PASO 6: TEST - Ejecutar tests unitarios
    # ============================================
    - name: "ğŸ§ª TEST: Ejecutar tests unitarios"
      run: |
        echo "=== Ejecutando 20+ tests unitarios con JUnit 5 ==="
        mvn test -v

    # ============================================
    # PASO 7: COVERAGE - Generar reporte de cobertura
    # ============================================
    - name: "ğŸ“Š COVERAGE: Generar reporte de cobertura (JaCoCo)"
      run: |
        echo "=== Generando reporte de cobertura de cÃ³digo ==="
        mvn jacoco:report

    - name: "ğŸ“ˆ COVERAGE: Mostrar estadÃ­sticas de cobertura"
      run: |
        if [ -f target/site/jacoco/index.html ]; then
          echo "âœ… Reporte de cobertura generado exitosamente"
          echo "ğŸ“ UbicaciÃ³n: target/site/jacoco/index.html"
        fi

    # ============================================
    # PASO 8: PACKAGE - Generar el JAR
    # ============================================
    - name: "ğŸ“¦ PACKAGE: Compilar y generar el JAR"
      run: |
        echo "=== Compilando el JAR del proyecto ==="
        mvn package -DskipTests -q

    # ============================================
    # PASO 9: Upload - Subir artefactos
    # ============================================
    - name: "ğŸ“¤ Upload: Subir artefacto JAR"
      uses: actions/upload-artifact@v4
      with:
        name: biblioteca-app-jar
        path: biblioteca-app/target/*.jar
        retention-days: 5

    # ============================================
    # PASO 10: Upload - Reporte de cobertura
    # ============================================
    - name: "ğŸ“¤ Upload: Subir reporte de cobertura"
      uses: actions/upload-artifact@v4
      with:
        name: jacoco-coverage-report
        path: biblioteca-app/target/site/jacoco/
        retention-days: 7


    # ============================================
    # PASO 11: Resumen del pipeline
    # ============================================
    - name: "âœ¨ Resumen: Pipeline completado exitosamente"
      if: success()
      run: |
        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "âœ… PIPELINE CI/CD COMPLETADO EXITOSAMENTE"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "âœ“ LINT: AnÃ¡lisis estÃ¡tico completado"
        echo "âœ“ FORMAT CHECK: Estilo validado"
        echo "âœ“ COMPILE: CompilaciÃ³n exitosa"
        echo "âœ“ TEST: Tests unitarios pasados"
        echo "âœ“ COVERAGE: Reporte de cobertura generado"
        echo "âœ“ BUILD: Artefactos generados"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
    # ============================================
    # PASO 12: Generar Maven Wrapper
    - name: "Generar Maven Wrapper"
      run: mvn wrapper:wrapper